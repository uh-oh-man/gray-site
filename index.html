<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gray-style Hub</title>
<style>
  :root{
    --bg: url("https://raw.githubusercontent.com/uh-oh-man/downloads/refs/heads/main/VRChat_1920x1080_2021-07-12_12-26-59.521.png");
    --ink:#bfbfbf;
    --shadow: rgba(0,0,0,.45);
    --glass: rgba(40,40,40,.35);
    --glass-strong: rgba(40,40,40,.55);
    --green:#4caf50;
    --red:#e53935;
  }

  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body{
    margin:0;
    font-family: ui-rounded, "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial;
    color: var(--ink);
    background: #111;
    overflow-x: hidden;
  }

  /* Background */
  .bg{ position: fixed; inset: 0; background-image: var(--bg); background-size: cover; background-position: center; filter: saturate(1.05) brightness(.92); transform: scale(1.02); z-index: -2; }
  .vignette{ position: fixed; inset: 0; background: radial-gradient(120% 120% at 70% 30%, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 55%, rgba(0,0,0,.65) 100%); pointer-events:none; z-index:-1; }

  /* Right panel layout */
  .panel{ width:min(520px, 92vw); margin: clamp(18px, 5vw, 40px); margin-left:auto; padding: clamp(18px, 4vw, 28px); background: var(--glass); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,.08); border-radius: 18px; box-shadow: 0 20px 50px var(--shadow); }
  .brand{ display:flex; justify-content:flex-end; align-items:center; gap:14px; margin-bottom: 18px; }
  .brand h1{ margin:0; font-size: 40px; font-weight: 700; text-shadow: 0 2px 12px rgba(0,0,0,.6); }

  .grid{ margin-top:10px; display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 18px; }
  .tile{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; padding:16px 10px; text-decoration:none; color:var(--ink); background: linear-gradient(180deg, var(--glass), var(--glass-strong)); border:1px solid rgba(255,255,255,.09); border-radius:16px; box-shadow: 0 12px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05); transition: transform .12s ease, background .2s ease, box-shadow .2s ease; cursor:pointer; }
  .tile:hover{ transform: translateY(-2px); background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.45)); box-shadow: 0 16px 36px rgba(0,0,0,.45); }
  .tile svg{ width:54px; height:54px; opacity:.95; filter: drop-shadow(0 2px 4px rgba(0,0,0,.35)); }
  .label{ font-size:18px; font-weight:600; text-align:center; }

  /* ---------- Modal (no tint, clicks pass through) ---------- */
  .modal-backdrop{ position: fixed; inset:0; display:none; background: transparent; backdrop-filter: none; z-index: 999; pointer-events:none; }
  .modal-backdrop[aria-hidden="false"]{ display:block; }

  .modal{ position: fixed; width:min(520px, 92vw); background: #161616; border:1px solid #2f2f2f; border-radius: 14px; box-shadow: 0 24px 60px rgba(0,0,0,.55); color:#fff; left:50%; top:50%; pointer-events:auto; opacity:0; transform: scale(.92); }

  /* Open/close animations */
  @keyframes popIn { from { opacity:0; transform:scale(.88); filter:blur(6px); } to { opacity:1; transform:scale(1); filter:blur(0); } }
  @keyframes popOut { from { opacity:1; transform:scale(1); filter:blur(0); } to { opacity:0; transform:scale(.92); filter:blur(6px); } }
  .modal.open{ animation: popIn .26s cubic-bezier(.2,.75,.2,1) forwards; }
  .modal.close{ animation: popOut .18s ease forwards; }

  .titlebar{ background: linear-gradient(180deg, #222, #1a1a1a); color:#e8e8e8; display:flex; align-items:center; justify-content:space-between; padding: 10px 12px; font-weight:600; cursor:move; border-radius: 14px 14px 0 0; user-select:none; }
  .titlebar .title{ display:flex; align-items:center; gap:8px; }
  .xp-close{ appearance:none; border:none; cursor:pointer; width:24px; height:24px; border-radius:6px; background: #c04a45; color:#fff; font-weight:900; line-height:24px; text-align:center; padding:0; }
  .xp-close:hover{ background:#ff5a55; }
  .body{ padding:18px; }

  /* Code UI */
  .code-display{ display:flex; justify-content:center; gap:8px; margin-bottom:10px; }
  .code-dot{ width:14px; height:14px; border-radius:999px; border:2px solid var(--green); background: transparent; box-shadow: 0 0 10px rgba(76,175,80,.35) inset; }
  .code-dot.filled{ background: var(--green); }
  @keyframes flashRed { 0%{ background: var(--green); border-color: var(--green);} 100%{ background: var(--red); border-color: var(--red);} }
  .code-display.error .code-dot{ animation: flashRed 0.15s ease-in-out 6 alternate; }
  .code-input{ display:flex; justify-content:center; margin:8px 0 16px; }
  .code-input input{ width:160px; text-align:center; padding:10px 12px; border-radius:12px; background:#121212; color:#cfe9d1; border:1px solid #2f4f2f; outline:none; font-size:18px; letter-spacing:4px; }
  .code-input input:focus{ box-shadow:0 0 0 3px rgba(76,175,80,.25); border-color:#3f8f4a; }

  .keypad{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
  .keypad button{ padding:16px; font-size:18px; background:#222; color:#fff; border:1px solid #333; border-radius:12px; cursor:pointer; transition:transform .06s ease, background .2s ease, border-color .2s ease; }
  .keypad button:active{ transform: scale(.98); }
  .keypad button:hover{ background:#2a2a2a; border-color:#3a3a3a; }
  .keypad .blank{ visibility:hidden; }

  .enter-btn{ margin-top:12px; width:100%; padding:14px; font-size:18px; border:none; border-radius:10px; background:var(--green); color:#0e200f; font-weight:700; cursor:pointer; box-shadow: 0 8px 22px rgba(76,175,80,.25); }

  /* Transition to actions */
  .stage{ position:relative; overflow:hidden; }
  .view{ opacity:0; transform: translateY(6px); transition: opacity .22s ease, transform .22s ease; }
  .view.show{ opacity:1; transform: translateY(0); }

  /* Progress & results UI */
  .progress-wrap{ display:flex; flex-direction:column; align-items:center; gap:12px; }
  .progress-bar{ width: 86%; height: 14px; background:#2a2a2a; border-radius: 999px; overflow:hidden; border:1px solid #333; }
  .progress-fill{ width:0%; height:100%; background: linear-gradient(90deg, #69d46f, #4caf50); transition: width .5s ease; }
  .status-text{ color:#eaeaea; font-size:14px; opacity:.9; }
  .muted{ color:#a7a7a7; font-size:12px; opacity:.85; text-align:center; }
  .inline-actions{ display:flex; gap:10px; justify-content:center; margin-top:8px; }
  .inline-actions .btn{ padding:10px 12px; border-radius:10px; border:1px solid #2f2f2f; background:#232323; color:#eaeaea; cursor:pointer; }
  .inline-actions .btn:hover{ background:#2c2c2c; }
  .missing-wrap{ width:100%; max-width:420px; display:none; flex-direction:column; gap:10px; }
  .missing-list{ max-height:180px; overflow:auto; padding:8px; border:1px solid #333; border-radius:10px; background:#1c1c1c; }
  .missing-item{ display:flex; align-items:center; gap:10px; padding:6px 4px; border-bottom:1px dotted #2b2b2b; }
  .missing-item:last-child{ border-bottom:none; }
  .actions-row{ display:flex; justify-content:flex-end; gap:10px; }
  .small-btn{ padding:10px 12px; border-radius:10px; border:1px solid #2f2f2f; background:#2a2a2a; color:#eaeaea; cursor:pointer; }
  .small-btn:hover{ background:#333; }
  .extra-wrap{ width:100%; max-width:420px; display:none; flex-direction:column; gap:10px; }
  .extra-list{ max-height:180px; overflow:auto; padding:8px; border:1px solid #333; border-radius:10px; background:#1c1c1c; }
</style>
</head>
<body>
  <div class="bg"></div>
  <div class="vignette"></div>

  <main class="panel">
    <div class="brand"><h1>Gray</h1></div>
    <section class="grid">
      <a class="tile" href="#"><svg viewBox="0 0 64 64"><path fill="currentColor" d="M16 18c8-6 24-6 32 0l-2 6c4 2 6 5 6 9 0 10-10 17-20 17S12 43 12 33c0-4 2-7 6-9l-2-6z"/><circle cx="26" cy="34" r="3" fill="#111"/><circle cx="38" cy="34" r="3" fill="#111"/></svg><div class="label">Discord</div></a>
      <a class="tile" href="#"><svg viewBox="0 0 64 64"><circle cx="22" cy="26" r="8" fill="currentColor"/><circle cx="42" cy="26" r="8" fill="currentColor" opacity=".85"/><rect x="14" y="36" width="36" height="10" rx="5" fill="currentColor"/></svg><div class="label">VR Group</div></a>
      <button class="tile" id="mcBtn" type="button"><svg viewBox="0 0 64 64"><rect x="8" y="8" width="48" height="48" rx="6" fill="currentColor"/><rect x="20" y="22" width="10" height="10" fill="#111"/><rect x="34" y="22" width="10" height="10" fill="#111"/><rect x="28" y="32" width="8" height="12" fill="#111"/><rect x="20" y="40" width="8" height="8" fill="#111"/><rect x="36" y="40" width="8" height="8" fill="#111"/></svg><div class="label">Minecraft</div></button>
    </section>
  </main>

  <div class="modal-backdrop" id="mcModal" aria-hidden="true">
    <div class="modal" id="mcWindow" role="dialog" aria-labelledby="mcTitle">
      <div class="titlebar" id="titleBar">
        <div class="title" id="mcTitle">Minecraft</div>
        <button class="xp-close" id="mcClose" aria-label="Close">×</button>
      </div>
      <div class="body stage" id="mcBody"></div>
    </div>
  </div>

<script type="module">
  const mcBtn = document.getElementById('mcBtn');
  const mcModal = document.getElementById('mcModal');
  const mcWindow = document.getElementById('mcWindow');
  const mcClose = document.getElementById('mcClose');
  const mcBody = document.getElementById('mcBody');

  const secret = 'MDcxMw=='; // btoa('0713')
  let inputCode = '';
  let keyHandlerAttached = false;
  let locked = false;
  let isClosing = false;

  /* ---------- Views ---------- */
  function renderKeypad(){
    inputCode = '';
    mcBody.innerHTML = `
      <div class="view show" id="keypadView">
        <div class="code-display" id="codeDisplay">
          <span class="code-dot" data-i="0"></span>
          <span class="code-dot" data-i="1"></span>
          <span class="code-dot" data-i="2"></span>
          <span class="code-dot" data-i="3"></span>
        </div>
        <div class="code-input"><input id="codeInput" type="text" inputmode="numeric" pattern="\\d*" maxlength="4" placeholder="____" aria-label="Enter 4-digit code" /></div>
        <div class="keypad">
          <button data-k="1">1</button>
          <button data-k="2">2</button>
          <button data-k="3">3</button>
          <button data-k="4">4</button>
          <button data-k="5">5</button>
          <button data-k="6">6</button>
          <button data-k="7">7</button>
          <button data-k="8">8</button>
          <button data-k="9">9</button>
          <button class="blank" tabindex="-1" aria-hidden="true"></button>
          <button data-k="0">0</button>
          <button id="backBtn" aria-label="Backspace">⌫</button>
        </div>
        <button class="enter-btn" id="enterBtn" disabled>Enter</button>
      </div>`;

    const dots = [...document.querySelectorAll('.code-dot')];
    const enterBtn = document.getElementById('enterBtn');
    const backBtn = document.getElementById('backBtn');
    const codeInput = document.getElementById('codeInput');
    const codeDisplay = document.getElementById('codeDisplay');

    function reflectInput(){ codeInput.value = '*'.repeat(inputCode.length); }
    function refreshDots(){
      reflectInput();
      dots.forEach((d,i)=> d.classList.toggle('filled', i < inputCode.length));
      enterBtn.disabled = inputCode.length !== 4;
    }

    function doErrorFlash(){
      locked = true;
      codeDisplay.classList.add('error');
      setTimeout(()=>{
        codeDisplay.classList.remove('error');
        inputCode='';
        refreshDots();
        locked = false;
      }, 950);
    }

    // keypad clicks
    mcBody.querySelectorAll('[data-k]').forEach((btn)=>{
      btn.addEventListener('click', ()=>{
        if(locked) return;
        if(inputCode.length >= 4) return;
        inputCode += btn.getAttribute('data-k');
        refreshDots();
      });
    });

    // backspace
    backBtn.addEventListener('click', ()=>{ if(locked) return; inputCode = inputCode.slice(0,-1); refreshDots(); });

    // enter
    enterBtn.addEventListener('click', ()=>{
      if(locked) return;
      if(btoa(inputCode) === secret){ transitionToActions(); }
      else { doErrorFlash(); }
    });

    // keyboard support
    function keyHandler(e){
      if(locked) return;
      if(/^[0-9]$/.test(e.key)){
        if(inputCode.length < 4){ inputCode += e.key; refreshDots(); }
      } else if(e.key === 'Backspace'){
        inputCode = inputCode.slice(0,-1); refreshDots();
      } else if(e.key === 'Enter'){
        enterBtn.click();
      }
    }
    if(!keyHandlerAttached){ window.addEventListener('keydown', keyHandler); keyHandlerAttached = true; }

    setTimeout(()=>{ if(codeInput) codeInput.focus(); }, 0);
    refreshDots();
  }

  function transitionToActions(){
    const view = document.getElementById('keypadView');
    view.classList.remove('show');
    setTimeout(()=>{ renderActions(); }, 200);
  }

  function renderActions(){
    mcBody.innerHTML = `
      <div class="view show" id="actionsView" style="display:flex; flex-direction:column; gap:12px; align-items:center;">
        <div style="display:flex; gap:10px; width:100%; max-width:420px; justify-content:center;">
          <button id="upgradeBtn" class="enter-btn" style="flex:1;">Upgrade/Install</button>
          <button id="setupBtn" class="enter-btn" style="flex:1; background:#3c3c3c; color:#eaeaea; box-shadow:none;">Setup</button>
        </div>
        <div class="muted" style="max-width:360px;">
          This step works best on browsers that support selecting folders (Chrome or Edge on desktop). Please choose your <b>modpack's root folder</b> — the one that usually contains a <code>mods</code> folder.
        </div>
        <div id="progressBlock" class="progress-wrap" style="display:none; width:100%; max-width:420px;">
          <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
          <div class="status-text" id="statusText">awaiting user permission</div>
          <div id="permDeniedActions" class="inline-actions" style="display:none;"></div>
          <div id="decisionBlock" class="inline-actions" style="display:none;">
            <button id="continueRoot" class="btn">Continue in this folder</button>
            <button id="chooseAnother" class="btn">Choose a different folder</button>
          </div>
          <div id="missingWrap" class="missing-wrap">
            <div class="muted">Missing mods (default selected):</div>
            <div id="missingList" class="missing-list"></div>
            <div class="actions-row">
              <button id="installSelected" class="small-btn">Install selected</button>
            </div>
          </div>
          <div id="extraWrap" class="extra-wrap">
            <div class="muted">Showing all mods that are not in the Modpack. Default Selected:</div>
            <div id="extraList" class="extra-list"></div>
            <div class="actions-row">
              <button id="deleteBtn" class="small-btn">Delete</button>
            </div>
            <div id="extraConfirm" class="inline-actions" style="display:none;">
              <button id="confirmDelete" class="btn">Confirm delete</button>
              <button id="cancelDelete" class="btn">Cancel</button>
            </div>
          </div>
        </div>
      </div>`;

    const progressBlock = document.getElementById('progressBlock');
    const progressFill  = document.getElementById('progressFill');
    const statusText    = document.getElementById('statusText');
    const permDeniedUI  = document.getElementById('permDeniedActions');
    const decisionBlock = document.getElementById('decisionBlock');
    const continueRoot  = document.getElementById('continueRoot');
    const chooseAnother = document.getElementById('chooseAnother');
    const missingWrap   = document.getElementById('missingWrap');
    const missingList   = document.getElementById('missingList');
    const installBtn    = document.getElementById('installSelected');

    const extraWrap     = document.getElementById('extraWrap');
    const extraList     = document.getElementById('extraList');
    const deleteBtn     = document.getElementById('deleteBtn');
    const extraConfirm  = document.getElementById('extraConfirm');
    const confirmDelete = document.getElementById('confirmDelete');
    const cancelDelete  = document.getElementById('cancelDelete');

    const setupBtn      = document.getElementById('setupBtn');

    // ---- Permission denied UI (Back / Try again) ----
    function showBackTryAgain(msg){
      progressBlock.style.display = 'flex';
      statusText.textContent = msg || 'permission denied';
      permDeniedUI.innerHTML = '';
      permDeniedUI.style.display = 'flex';
      const back = document.createElement('button'); back.className = 'btn'; back.textContent = 'Back';
      const retry = document.createElement('button'); retry.className = 'btn'; retry.textContent = 'Try again';
      permDeniedUI.append(back, retry);
      back.onclick = ()=>{ renderActions(); };
      retry.onclick = async ()=>{ permDeniedUI.style.display = 'none'; statusText.textContent = 'awaiting user permission'; await requestDirectoryAndScan(); };
    }

    let currentDirHandle = null;
    let remoteCache = [];

    async function listLocalJars(dirHandle){
      const files = [];
      try{
        for await (const [name, handle] of dirHandle.entries()){
          if(handle.kind === 'file' && name.toLowerCase().endsWith('.jar')) files.push(name);
        }
      }catch(err){ console.warn('listLocalJars error', err); }
      return files.sort((a,b)=> a.localeCompare(b));
    }

    async function fetchRemoteJars(){
      const api = 'https://api.github.com/repos/uh-oh-man/downloads/contents/minecraft-mods';
      const res = await fetch(api, { headers: { 'Accept':'application/vnd.github+json' }});
      if(!res.ok) throw new Error('Failed to fetch remote mod list');
      const json = await res.json();
      const files = json.filter(it=> it.type==='file' && /\.jar$/i.test(it.name))
                        .map(it=> ({ name: it.name, url: it.download_url }));
      remoteCache = files;
      return files;
    }

    function renderMissingChecklist(missing){
      missingList.innerHTML = '';
      missing.forEach(m=>{
        const row = document.createElement('div'); row.className = 'missing-item';
        const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = true; cb.dataset.name = m.name; cb.dataset.url = m.url || '';
        const label = document.createElement('label'); label.textContent = m.name; label.style.userSelect = 'text';
        row.append(cb, label); missingList.appendChild(row);
      });
      missingWrap.style.display = missing.length ? 'flex' : 'none';
    }

    function renderExtraChecklist(extras){
      extraList.innerHTML = '';
      extras.forEach(name=>{
        const row = document.createElement('div'); row.className = 'missing-item';
        const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = true; cb.dataset.name = name;
        const label = document.createElement('label'); label.textContent = name; label.style.userSelect = 'text';
        row.append(cb, label); extraList.appendChild(row);
      });
      extraWrap.style.display = extras.length ? 'flex' : 'none';
    }

    async function scanRootForMods(rootHandle){
      statusText.textContent = 'scanning…';
      progressFill.style.width = '10%';
      let modsHandle = null;
      try { modsHandle = await rootHandle.getDirectoryHandle('mods', { create:false }); } catch(_) { modsHandle = null; }
      if(modsHandle){
        statusText.textContent = "found 'mods' — scanning…";
        progressFill.style.width = '20%';
        return modsHandle;
      } else {
        statusText.textContent = "no 'mods' folder in selected location";
        decisionBlock.style.display = 'flex';
        return null;
      }
    }

    async function orchestrateCompareAndList(dirHandle){
      currentDirHandle = dirHandle;
      const [local, remote] = await Promise.all([ listLocalJars(dirHandle), fetchRemoteJars() ]);
      const localSet = new Set(local.map(n=> n.toLowerCase()));
      const missing = remote.filter(r=> !localSet.has(r.name.toLowerCase()));
      renderMissingChecklist(missing);
      statusText.textContent = missing.length ? (`Missing ${missing.length} mod(s).`) : 'All required mods are present.';
      if(!missing.length){
        missingWrap.style.display = 'none';
        const actionsView = document.getElementById('actionsView');
        let cont = document.getElementById('continueToCleanup');
        if(!cont){
          cont = document.createElement('button');
          cont.id = 'continueToCleanup'; cont.className = 'small-btn'; cont.textContent = 'Continue';
          actionsView.appendChild(cont);
          cont.addEventListener('click', async ()=>{ cont.remove(); statusText.textContent = 'Scanning for local-only mods…'; await scanExtrasFlow(); });
        }
      }
    }

    async function requestDirectoryAndScan(){
      if(!window.showDirectoryPicker){ showBackTryAgain('Your browser does not support folder selection.'); return; }
      try{
        const handle = await window.showDirectoryPicker({ mode:'readwrite' });
        const mods = await scanRootForMods(handle);
        if(mods){ await orchestrateCompareAndList(mods); }
        else {
          await new Promise((resolve)=>{
            function cleanup(){ continueRoot.removeEventListener('click', onContinue); chooseAnother.removeEventListener('click', onChoose); }
            async function onContinue(){ cleanup(); decisionBlock.style.display = 'none'; statusText.textContent = 'continuing in selected folder… (no mods folder)'; await orchestrateCompareAndList(handle); resolve(); }
            async function onChoose(){ cleanup(); decisionBlock.style.display = 'none'; await requestDirectoryAndScan(); resolve(); }
            continueRoot.addEventListener('click', onContinue);
            chooseAnother.addEventListener('click', onChoose);
          });
        }
      }catch(err){ const msg = (err && err.name === 'AbortError') ? 'permission canceled' : 'permission denied'; showBackTryAgain(msg); }
    }

    async function installSelectedMods(){
      if(!currentDirHandle) return;
      const checks = [...missingList.querySelectorAll('input[type="checkbox"]:checked')];
      if(!checks.length){ statusText.textContent = 'Nothing selected.'; return; }
      let done = 0;
      for(const cb of checks){
        const name = cb.dataset.name; const url = cb.dataset.url;
        try{
          const resp = await fetch(url); if(!resp.ok) throw new Error('download failed: '+name);
          const blob = await resp.blob();
          const fileHandle = await currentDirHandle.getFileHandle(name, { create:true });
          const writable = await fileHandle.createWritable(); await writable.write(blob); await writable.close();
          done++; const pct = Math.min(90, 30 + Math.round((done/checks.length)*60));
          progressFill.style.width = pct + '%'; statusText.textContent = `installed ${done}/${checks.length}`;
        }catch(err){ console.warn('install error', name, err); statusText.textContent = 'error installing ' + name; }
      }
      missingWrap.style.display = 'none'; decisionBlock.style.display = 'none'; statusText.textContent = 'Install complete. Scanning for local-only mods…';
      await scanExtrasFlow();
    }

    async function scanExtrasFlow(){
      const localAfter = await listLocalJars(currentDirHandle);
      const remoteNames = new Set((remoteCache||[]).map(r=> r.name.toLowerCase()));
      const extras = localAfter.filter(n=> !remoteNames.has(n.toLowerCase()));

      function appendFinish(){
        const actionsView = document.getElementById('actionsView');
        let finish = document.getElementById('finishBtn');
        if(!finish){ finish = document.createElement('button'); finish.id = 'finishBtn'; finish.className = 'enter-btn'; finish.textContent = 'Finish'; finish.style.width = '100%'; finish.style.maxWidth = '260px'; finish.addEventListener('click', ()=> closeModal()); actionsView.appendChild(finish); }
      }

      progressFill.style.width = '100%';

      if(extras.length){
        statusText.textContent = `Found ${extras.length} local-only mod(s).`;
        renderExtraChecklist(extras);
        appendFinish();
        deleteBtn.onclick = ()=>{ extraConfirm.style.display = 'flex'; };
        cancelDelete.onclick = ()=>{ extraConfirm.style.display = 'none'; };
        confirmDelete.onclick = async ()=>{
          const sel = [...extraList.querySelectorAll('input[type="checkbox"]:checked')].map(cb=> cb.dataset.name);
          let removed = 0;
          for(const name of sel){ try{ await currentDirHandle.removeEntry(name); removed++; } catch(err){ console.warn('remove error', name, err); } }
          statusText.textContent = sel.length ? (`deleted ${removed}/${sel.length}`) : 'nothing to delete';
          extraWrap.style.display = 'none'; appendFinish();
        };
      } else {
        statusText.textContent = 'No local-only mods found.';
        extraWrap.style.display = 'none'; appendFinish();
      }
    }

    // ---- Setup flow ----
    function renderLauncherSelector(){
      mcBody.innerHTML = `
        <div class="view show" id="setupView" style="display:flex; flex-direction:column; gap:14px; align-items:center;">
          <h3 style="margin:6px 0 2px; font-weight:700;">Select your Minecraft Launcher</h3>
          <div style="display:flex; gap:12px; width:100%; max-width:420px; justify-content:center;">
            <button id="launcherCurseforge" class="enter-btn" style="flex:1;">Curseforge</button>
            <button id="launcherCracked" class="enter-btn" style="flex:1; background:#3c3c3c; color:#eaeaea; box-shadow:none;">Cracked Minecraft</button>
          </div>
          <div class="muted">This will clear the installer screen and open a new setup view.</div>
        </div>`;
      document.getElementById('launcherCurseforge').addEventListener('click', ()=> openLauncherScreen('curseforge'));
      document.getElementById('launcherCracked').addEventListener('click', ()=> openLauncherScreen('cracked'));
    }

    function openLauncherScreen(kind){
      const title = (kind === 'curseforge') ? 'Curseforge Setup' : 'Cracked Minecraft Setup';
      mcBody.innerHTML = `
        <div class="view show" id="launcherScreen" style="display:flex; flex-direction:column; gap:12px; align-items:center;">
          <h3 style="margin:6px 0 4px; font-weight:700;">${title}</h3>
          <div class="muted" style="max-width:420px; text-align:center;">Blank screen for now — we'll build this flow next.</div>
        </div>`;
    }

    // ---- Bindings inside this view ----
    const upgradeBtn = document.getElementById('upgradeBtn');
    upgradeBtn.addEventListener('click', async (e)=>{
      e.preventDefault(); e.stopPropagation();
      const btn = e.currentTarget; const setup = document.getElementById('setupBtn');
      btn.style.transition = 'opacity .15s ease'; btn.style.opacity = '0';
      if (setup) { setup.style.transition = 'opacity .15s ease'; setup.style.opacity = '0'; }
      setTimeout(()=>{ try{ btn.remove(); }catch(_){} }, 180);
      setTimeout(()=>{ if(setup){ try{ setup.remove(); }catch(_){} } }, 180);
      progressBlock.style.display = 'flex'; statusText.textContent = 'awaiting user permission';
      await requestDirectoryAndScan();
    });

    installBtn.addEventListener('click', async (e)=>{ e.preventDefault(); await installSelectedMods(); });
    setupBtn.addEventListener('click', (e)=>{ e.preventDefault(); renderLauncherSelector(); });
  }

  /* ---------- Open/Close ---------- */
  function openModal(){
    if(isClosing) return;
    mcModal.setAttribute('aria-hidden','false');
    mcWindow.classList.remove('close');
    void mcWindow.offsetWidth;
    const w = mcWindow.offsetWidth, h = mcWindow.offsetHeight;
    const margin = 10;
    const left = Math.max(margin, Math.min((window.innerWidth - w)/2, window.innerWidth - w - margin));
    const top  = Math.max(margin, Math.min((window.innerHeight - h)/2, window.innerHeight - h - margin));
    mcWindow.style.left = left + 'px'; mcWindow.style.top  = top + 'px';
    mcWindow.classList.add('open');
    mcWindow.addEventListener('animationend', ()=>{ mcWindow.style.transform = 'scale(1)'; }, {once:true});
    renderKeypad();
  }

  function closeModal(){
    if(isClosing) return; isClosing = true;
    const rect = mcWindow.getBoundingClientRect(); mcWindow.style.left = rect.left + 'px'; mcWindow.style.top  = rect.top + 'px';
    mcWindow.classList.remove('open'); mcWindow.classList.add('close'); inputCode='';
    mcWindow.addEventListener('animationend', ()=>{ mcModal.setAttribute('aria-hidden','true'); mcWindow.classList.remove('close'); mcWindow.style.transform = 'scale(1)'; isClosing = false; }, {once:true});
  }

  /* ---------- Dragging with bounds & resize clamp ---------- */
  const titleBar = document.getElementById('titleBar');
  let drag = { on:false, dx:0, dy:0 };
  const MARGIN = 10;
  function clampToViewport(x, y){
    const w = mcWindow.offsetWidth, h = mcWindow.offsetHeight;
    const minX = MARGIN, minY = MARGIN;
    const maxX = Math.max(MARGIN, window.innerWidth  - w - MARGIN);
    const maxY = Math.max(MARGIN, window.innerHeight - h - MARGIN);
    return { x: Math.min(Math.max(x, minX), maxX), y: Math.min(Math.max(y, minY), maxY) };
  }
  titleBar.addEventListener('mousedown', (e)=>{
    drag.on = true; const rect = mcWindow.getBoundingClientRect();
    mcWindow.style.animation = 'none'; mcWindow.style.transform = 'scale(1)';
    mcWindow.style.left = rect.left + 'px'; mcWindow.style.top  = rect.top  + 'px';
    drag.dx = e.clientX - rect.left; drag.dy = e.clientY - rect.top;
  });
  window.addEventListener('mousemove', (e)=>{
    if(!drag.on) return;
    const w = mcWindow.offsetWidth, h = mcWindow.offsetHeight;
    const minX = MARGIN, minY = MARGIN;
    const maxX = Math.max(minX, window.innerWidth  - w - minX);
    const maxY = Math.max(minY, window.innerHeight - h - minY);
    let nextX = e.clientX - drag.dx; let nextY = e.clientY - drag.dy;
    if(nextX < minX) nextX = minX; if(nextX > maxX) nextX = maxX;
    if(nextY < minY) nextY = minY; if(nextY > maxY) nextY = maxY;
    mcWindow.style.left = nextX + 'px'; mcWindow.style.top  = nextY + 'px';
  });
  window.addEventListener('mouseup', ()=>{
    if(!drag.on) return; drag.on = false; const rect = mcWindow.getBoundingClientRect(); const next = clampToViewport(rect.left, rect.top); mcWindow.style.left = next.x + 'px'; mcWindow.style.top  = next.y + 'px'; mcWindow.style.animation = '';
  });
  window.addEventListener('resize', ()=>{ if(mcModal.getAttribute('aria-hidden') === 'true') return; const rect = mcWindow.getBoundingClientRect(); const next = clampToViewport(rect.left, rect.top); mcWindow.style.left = next.x + 'px'; mcWindow.style.top  = next.y + 'px'; });

  /* ---------- Bindings ---------- */
  mcBtn.addEventListener('click', (e)=>{ e.preventDefault(); openModal(); });
  mcClose.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); closeModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && mcModal.getAttribute('aria-hidden') === 'false') closeModal(); });

  /* ---------- Self-tests (console) ---------- */
  (function selfTests(){
    try{
      const tests = [];
      tests.push({name:'secret matches 0713', pass: secret === btoa('0713')});
      const clampLow = clampToViewport(-999,-999); const clampHigh = clampToViewport(window.innerWidth+999, window.innerHeight+999);
      tests.push({name:'clamp lower >= margin', pass: clampLow.x >= 10 && clampLow.y >= 10});
      tests.push({name:'clamp upper <= viewport', pass: clampHigh.x <= window.innerWidth && clampHigh.y <= window.innerHeight});
      tests.push({name:'requestDirectoryAndScan is async', pass: /async\s+function\s+requestDirectoryAndScan\(/.test(requestDirectoryAndScan.toString())});
      console.groupCollapsed('%cSelf-tests','color:#9f9'); tests.forEach(t=> console.log(t.pass ? '✅' : '❌', t.name)); console.groupEnd();
    }catch(err){ console.warn('Self-tests error', err); }
  })();
</script>
</body>
</html>
